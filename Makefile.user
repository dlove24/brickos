### ==========================================================================
###  $Id: Makefile.user,v 1.6 2002/10/15 06:51:55 stephmo Exp $
###  FILE: Makefile.user - support for building programs run under brickOS
###  brickOS - the independent LEGO Mindstorms OS
### --------------------------------------------------------------------------
###       (this file is included by the  demo/ and demo/c++  Makefiles)


#  User application libraries. Comment out if linking
#  them statically to kernel in Makefile.kernel.
LIBS=-lc -lmint -lfloat -lc++

# linker command files dynamic executables.
DYNAMIC_LDS =$(KERNEL).lds
DLDFLAGS    =-T $(DYNAMIC_LDS) -relax -L$(BRICKOS_ROOT)lib

# base addresses to determine relocation info.
BASE1=0xb000
BASE2=0xb210

# Add config.h to include path.
CINC +=-I$(dir $(KERNEL))

#
# 2002.05.12 - Ted Hess <thess@users.sourceforge.net>
#
#	- Allow setting LNP Host Address on command line
ifdef LNP_HOSTADDR
CDEFINES =-DCONF_LNP_HOSTADDR=$(LNP_HOSTADDR)
endif

############ new dynamic executables stuff

# how to build executables dynamically linked to the kernel 
# set DYNAMIC_TEXT, DOBJECTS, DYNAMIC_LDS appropriately.
%.dcoff: %.o $(DOBJECTS) $(DYNAMIC_LDS)
	$(LD) $(DLDFLAGS) $*.o $(DOBJECTS) $(LIBS) -o $@ -Ttext $(BASE1) --oformat coff-h8300

# how to make barebones dymanic executable map files
%.dmap: %.dcoff
	$(NM) $< | sort > $@
	
# how to disassemble coff kernel
%.dis: %.dcoff
	$(OBJDUMP) $(ODFLAGS) $*.dcoff > $@
	
# how to merge map files with symbols
%.dis2: %.dmap %.dis
	$(MERGEMAP) $*.dmap $*.dis > $@
        
# how to make srec files of dynamic executables
%.ds1: %.o $(DOBJECTS) $(DYNAMIC_LDS)
	$(LD) $(DLDFLAGS) $*.o $(DOBJECTS) $(LIBS) -o $@ -Ttext $(BASE1)

# how to make srec files of dynamic executables
%.ds2: %.o $(DOBJECTS) $(DYNAMIC_LDS)	
	$(LD) $(DLDFLAGS) $*.o $(DOBJECTS) $(LIBS) -o $@ -Ttext $(BASE2)

%.lx: %.ds1 %.ds2
	$(MAKELX) $*.ds1 $*.ds2 $@


### --------------------------------------------------------------------------
###                          End of FILE: Makefile.user
### ==========================================================================
