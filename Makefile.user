##
## legOS - the independent LEGO Mindstorms OS
## Makefile.common - make rules for user executables
## (c) 1998, 1999 by Markus L. Noga <markus@noga.de>    
##

# User application libraries. Comment out if linking
# them statically to kernel in Makefile.kernel.
LIBS=-lc -lmint -lfloat -lc++

# linker command files dynamic executables.
DYNAMIC_LDS =$(KERNEL).lds
DLDFLAGS    =-T $(DYNAMIC_LDS) -relax -L$(LEGOS_ROOT)lib

# base addresses to determine relocation info.
BASE1=0xb000
BASE2=0xb210

# Add config.h to include path.
CINC +=-I$(dir $(KERNEL))

############ new dynamic executables stuff

# how to build executables dynamically linked to the kernel 
# set DYNAMIC_TEXT, DOBJECTS, DYNAMIC_LDS appropriately.
%.dcoff: %.o $(DOBJECTS) $(DYNAMIC_LDS)
	$(LD) $(DLDFLAGS) $*.o $(DOBJECTS) $(LIBS) -o $@ -Ttext $(BASE1) --oformat coff-h8300

# how to make barebones dymanic executable map files
%.dmap: %.dcoff
	$(NM) $< | sort > $@
	
# how to disassemble coff kernel
%.dis: %.dcoff
	$(OBJDUMP) $(ODFLAGS) $*.dcoff > $@
	
# how to merge map files with symbols
%.dis2: %.dmap %.dis
	$(MERGEMAP) $*.dmap $*.dis > $@
        
# how to make srec files of dynamic executables
%.ds1: %.o $(DOBJECTS) $(DYNAMIC_LDS)
	$(LD) $(DLDFLAGS) $*.o $(DOBJECTS) $(LIBS) -o $@ -Ttext $(BASE1)

# how to make srec files of dynamic executables
%.ds2: %.o $(DOBJECTS) $(DYNAMIC_LDS)	
	$(LD) $(DLDFLAGS) $*.o $(DOBJECTS) $(LIBS) -o $@ -Ttext $(BASE2)

%.lx: %.ds1 %.ds2
	$(MAKELX) $*.ds1 $*.ds2 $@
